// File: eeprom_init.c
// Inicjalizacja EEPROM domyslna zawartoscia

#include "eeprom_init.h"
#include <xc.h>
#include <stdint.h>

// Domyslna zawartosc EEPROM (256 bajtów)
//0x02-0x09    'Startup'   
//0x16-0x1D    '       '
//0x20-0x27    '       '
//0x2A-0x32    '       '
//0x34-0x3B    '       '
//0x3E-0x45    '       '
//0x5C-0x63    '       '
//0x64  0x99    ee_cal_gain   (LSB)   10393
//0x65  0x28    ee_cal_gain   (MSB)
//0x66  0x78    ee_cal_offset  (LSB)  120
//0x67  0x00    ee_cal_offset  (MSB)
//0x68  0xEE    ee_cal_point_1  (LSB)  750
//0x69  0x02    ee_cal_point_1  (MSB)
//0x6A  0x32    ee_cal_point_0  (LSB)  50
//0x6B  0x00    ee_cal_point_0  (MSB)
//0x6C	0x3C	ee_sleep_delay_sec (LSB)  60
//0x6D	0x00	ee_sleep_delay_sec (MSB)	
//0x6E	0xC8	ee_tune_auto_swr (LSB)	200
//0x6F	0x00	ee_tune_auto_swr (MSB)	
//0x70	0x64	ee_tune_stop_swr (LSB)	100
//0x71	0x00	ee_tune_stop_swr (MSB)	
//0x72	0x01	ee_tune_auto_enable	1
//0x73	0x01	ee_sleep_enable	1

const uint8_t eeprom_init_data[EEPROM_INIT_DATA_SIZE] = {
    0x00,0x00,0x53,0x74,0x61,0x72,0x74,0x75,0x70,0x20,0x00,0x00,0x20,0x20,0x20,0x20, // 0x00-0x0F
    0x20,0x20,0x20,0x20,0x00,0x00,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x00,0x00, // 0x10-0x1F
    0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x00,0x00,0x20,0x20,0x20,0x20,0x20,0x20, // 0x20-0x2F
    0x20,0x20,0x00,0x00,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x00,0x00,0x20,0x20, // 0x30-0x3F
    0x20,0x20,0x20,0x20,0x20,0x20,0x00,0x00,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20, // 0x40-0x4F
    0x00,0x00,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x00,0x00,0x20,0x20,0x20,0x20, // 0x50-0x5F
    0x20,0x20,0x20,0x20,0x99,0x28,0x78,0x00,0xEE,0x02,0x32,0x00,0x3C,0x00,0xC8,0x00, // 0x60-0x6F
    0x64,0x00,0x01,0x01,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF, // 0x70-0x7F
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF, // 0x80-0x8F
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF, // 0x90-0x9F
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF, // 0xA0-0xAF
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF, // 0xB0-0xBF
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF, // 0xC0-0xCF
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF, // 0xD0-0xDF
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF, // 0xE0-0xEF
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF  // 0xF0-0xFF   
};

void EEPROM_InitDefault(void)
{
    // Zapisz cala zawartosc EEPROM wedlug tablicy
    for (uint16_t i = 0; i <= 0xFF; i++) {
        eeprom_write(i, eeprom_init_data[i]);
    }
}

// Implementacja dla XC8 (PIC16F1938 i podobne)
void eeprom_write(uint8_t addr, uint8_t value)
{
    EEADRL = addr;      // Adres EEPROM
    EEDATL = value;     // Wartosc do zapisania
    EECON1bits.EEPGD = 0;   // Wybierz pamiec danych EEPROM
    EECON1bits.CFGS = 0;    // Wybierz pamiec EEPROM, nie konfiguracji
    EECON1bits.WREN = 1;    // Wlacz zapis

    // Sekwencja odblokowania (zgodnie z datasheet)
    uint8_t gie_state = INTCONbits.GIE; // Zapamietaj stan przerwan
    INTCONbits.GIE = 0;     // Wylacz przerwania
    EECON2 = 0x55;
    EECON2 = 0xAA;
    EECON1bits.WR = 1;      // Rozpocznij zapis
    while (EECON1bits.WR);  // Czekaj na zakonczenie zapisu
    EECON1bits.WREN = 0;    // Wylacz zapis
    INTCONbits.GIE = gie_state; // Przywróc stan przerwan
}

uint8_t eeprom_read(uint8_t addr)
{
    EEADRL = addr;          // Adres EEPROM
    EECON1bits.EEPGD = 0;   // Wybierz pamiec danych EEPROM
    EECON1bits.CFGS = 0;    // Wybierz pamiec EEPROM, nie konfiguracji
    EECON1bits.RD = 1;      // Rozpocznij odczyt
    NOP();                  // Zalecane przez Microchip
    return EEDATL;          // Zwróc odczytana wartosc
}